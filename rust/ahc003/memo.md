# AtCoder Heuristic Contest 003

## Solve

## 注意事項

- interactive
  - // fastout

## 理論値

- 1
  - 999999910
- 100
  - 99999991000
  - 10987654321

## test の実行

```bash
cargo run --release --bin tester in/0000.txt cargo run --bin a
python parallel.py
python compare_path_cost.py < hoge0006.txt 
```

## now condition

## memo

### 20210527

- 誤差の和についての考察
  - よさげなやつ(958M) 300で1.1Mくらい
  - 最悪なやつ(830M) 300で1.3Mくらい
  - smoothingがかなり悪さしてるように見える。
- 絶対誤差の和が大きい。なんなら昨日より
- meanを3000から4000に変更した。5000を目指したい。
- 全体的に想定よりも小さいパスコストになっているところが多い。なぜ…?

### 20210526

- 縦または横に連続10個をとって、そこを確定させる
  - あんまり効果なさそう
- 精度がいい場合は、更新しない。
  - 1Gくらい変わった。

### 20210525

- 最悪スコアが80Gぐらいなのがやばい気がする
  - 006
  - 最後まで良くない経路をたどっている
- 最高スコアも95Gくらいなのでうーん。
- クリティカルな改善が必要そう

- Rについて各操作ごとの正解の値との差を表示させるスクリプトを書いた。
- ついでに、各成分の差の絶対値の和(=X)も表示するようにした。
  - Xが全然減っていない

## small goal

- 各成分の差の絶対値の和を減らす

## future work

- [ ] パスに関連した部分だけをsmoothingする
  - パスを記録しておいて、特にだめな方に寄与したやつを修正する?
    - 修正済みも修正しちゃわない?
- [ ] 過去100回の成績が悪いものを大きめに修正する
- [ ] 大域的なスコアを見て、修正したい?
- [ ] 予想と異なるほど破壊的な変更を加えたい。
  - [ ] どっかを雑に削除して平均値入れちゃう?
- [x] コストの初期値を異なる値にする
  - 外を回そうとしたけどダメそうだった
  - [ ] 内側を軽くする??あんまり期待できない気がする
- [x] 序盤での修正をもっと激しくやりたい
  - もっと激しくできるかも
- [x] パスコストの更新時に平均をとる。あるいは、経過時間に合わせた重み付けをする
- [x] 縦横の平均を求める段階を作る。
  - 最初の100回くらい？
  - 近ければ、やるみたいな。んで、平均でいい感じに
- [x] パスの縦とか横とかの平均を利用して、hとかvとかの決定メカニズムから、定期的にパスコストを調整する

## tuning

Highest: 92612159582

- [ ] 初期値
- [ ] 重み付け

### mean

| mean |             |
| --   | --          |
| 5000 | 83206802331 |
| 4000 | 83417070647 |
| 6000 | 80733621400 |
| 3000 | 83794763773 |
| 2000 | 84005878925 |
| 1000 | 83692926893 |
| 0000 | 82991153648 |
|      |             |

- meanが小さいほど通ったことのない道を自動的に通るので、小さいほどスコアが上がっている。
- 2000を採用

### path cost の更新を平均にする

| original | new |             |
|----------|-----|-------------|
| 1        | 1   | 87908931595 |
| 2        | 1   | 86970637825 |
| 1        | 2   | 87993786747 |

### path cost を動的に変更する

びみょー

### path cost の更新を平均にする(1)

| original | new |             |
|----------|-----|-------------|
| 1        | 3   | 87282055907 |

### path cost を動的に変更する

N: all, k: number

| m: new | n: old  |             |
|--------|---------|-------------|
| N+k    | N*2+N-k | 86563383251 |
|        |         |             |

#### N/10で変化させる

| m: new | n: old | m | n |             |
|--------|--------|---|---|-------------|
| 1      | 0      | 1 | 3 | 87426868049 |
| 1      | 0      | 1 | 2 | 87888460613 |
| 1      | 1      | 1 | 2 | 89009860350 |

今回はこれを採用

### meanを変化させる

| mean  |             |
| --    | --          |
| =2000 | 89009860350 |
| 1500  | 88488140784 |
| 2500  | 89483119475 |
| 3000  | 89882956451 |
| 3500  | 90168718746 |
| 4000  | 90035440739 |
| 3750  | 90218611272 |

mean = 3750で

### 各行と各列で平均を取る操作を追加

x < K && x%k のときに実行
x は x 回目のクエリ
平均ごとにm,nの重みを付けて平均をとる
(m*(平均) + n*original)/(m+n)
t (<K)を境に(m,n)を変化させる

| K    | k  | m      | t   | n      |             |
| --   | -  |        |     |        | --          |
| 100  | 10 | 1      |     | 1      | 91236588896 |
| 1000 | 1  | 1      |     | 1      | 91084647339 |
| 100  | 1  | 1      |     | 1      | 91385234346 |
| 50   | 1  | 1      |     | 1      | 91055119920 |
| 200  | 1  | 1      |     | 1      | 91384372440 |
| 300  | 1  | 1      |     | 1      | 91481491768 |
| 400  | 1  | 1      |     | 1      | 91292470213 |
| 300  | 1  | 2      |     | 1      | 91366686299 |
| 300  | 1  | 1      |     | 2      | 91433108629 |
| 300  | 1  | 1      |     | 3      | 91464870390 |
| 300  | 1  | 2      |     | 3      | 91450963373 |
| 300  | 1  | 1      |     | 4      | 91370986731 |
| 300  | 1  | 1 -> 2 | 100 | 1 -> 3 | 91481491768 |
| 300  | 1  | 3 -> 2 | 100 | 2 -> 3 | 91267618768 |
| 300  | 1  | 1 -> 2 | 90  | 1 -> 3 | 91481491768 |
| 300  | 1  | 1 -> 2 | 200 | 1 -> 3 | 91481491768 |
| 300  | 1  | 2 -> 1 | 100 | 1 -> 1 | 91366686299 |
| 400  | 1  | 1 -> 2 | 100 | 1 -> 3 | 91292470213 |
| 200  | 1  | 1 -> 2 | 100 | 1 -> 3 | 91384372440 |

K = 300, k = 1, m = 1 -> 2, t = 100, n = 1 -> 3

### mean(2)

now = 3750

| m    |             |
| --   |             |
| 2000 | 89364277885 |
| 3000 | 90830092225 |
| 4000 | 91373766003 |
| 3500 | 91373766003 |
| 5000 | 88693788401 |

m = 3750

### 初期値に勾配をつける

序盤に外側を通りやすくするため。

| m    | M    |             |
| --   |      |             |
| 1000 | 5000 | 89989731943 |
| 2000 | 4000 | 90446030086 |
| 3000 | 4000 | 91167500040 |
| 3500 | 4000 | 91400138686 |
| 3750 | 4000 | 91510444592 |
| 3750 | 4250 | 91411499056 |
| 3800 | 4000 | 91457136948 |
| 3750 | 3850 | 91436705070 |
| 3750 | 3900 | 91417726798 |
| 3750 | 3950 | 91526320353 |
| 3850 | 3850 | 91537395324 |

m = 3850, M = 3850を採用
つまり、勾配を破棄して、mean=3850 を採用
提出した結果は、mean=3750の方が良かった。


### 初めを激しくする
追加した。
91171108033
初期値を0にするつもりだった。
i(回目) < initial_checkやってから、i==(initial_check-1)で平均を取る操作をする
i(回目) < initial_checkでの更新はm:nで平均をとる
(m*(new_cost) + n*original)/(m+n)

| mean | initial_check | m | n |             |
|      | ---           |   |   |             |
| 3850 | 10            | 1 | 0 | 91171108033 |
| 0    | 10            | 1 | 0 | 88207714672 |
| 0    | 20            | 1 | 0 | 88890038353 |
| 0    | 30            | 1 | 0 | 89494578840 |
| 0    | 40            | 1 | 0 | 89938842303 |
| 0    | 50            | 1 | 0 | 89967344014 |
| 0    | 100           | 1 | 0 | 89700282926 |
| 1000 | 10            | 1 | 0 | 88742736678 |
| 2000 | 10            | 1 | 0 | 89816822215 |
| 3000 | 10            | 1 | 0 | 90907333393 |
| 4000 | 10            | 1 | 0 | 90961331786 |
| 3500 | 10            | 1 | 0 | 91064029997 |
| 3500 | 10            | 2 | 1 | 91381438624 |
| 3500 | 10            | 4 | 1 | 91266882814 |
| 3500 | 10            | 3 | 1 | 91332650461 |
| 3500 | 10            | 5 | 2 | 91279365291 |
| 3500 | 10            | 3 | 2 | 91406001811 |



<!-- 一旦放棄。別のことをさきに確かめる。 -->

<!-- ### path cost を動的に変更する(2) -->

<!-- mean = 3850 -->

<!-- | m1 | n1 | c1  | m2 | n2 | c2  | m3 | n3 |             | -->
<!-- |----|----|-----|----|----|-----|----|----|-------------| -->
<!-- | 1  | 1  | 100 | 2  | 3  | 300 | 0  | 1  | 88966431259 | -->
<!-- | 1  | 1  | 100 | 2  | 3  | 300 | 2  | 3  |  -->





### visualize した。
途中での修正が行われていない気がした。
### 破壊的変更を加える

disruptive_threshold < |prediction - real_distance|/real_distance
m:nで重み付け
(m*(new_cost) + n*original)/(m+n)

| disruptive_threshold | m  | n |             |
| ---------            |    |   |             |
| 0.2                  | 1  | 0 | 88140355011 |
| 0.2                  | 10 | 1 | 88690265515 |
| 0.2                  | 5  | 1 | 89565222520 |
| 0.1                  | 1  | 0 | 86466562963 |
| 0.3                  | 1  | 0 | 90568603067 |
| 0.4                  | 1  | 0 | 91377917642 |
| 0.5                  | 1  | 0 | 91377917642 |

0.5はdisruptできてない

### 破壊的変更+平均をとる

| disruptive_threshold | m | n |             |
| ---------            |   |   |             |
| 0.2                  | 1 | 0 | 91465583511 |
| 0.3                  | 1 | 0 | 91753322277 |
| 0.4                  | 1 | 0 | 91696567258 |
| 0.35                 | 1 | 0 | 91778849454 |
| 0.3                  |   |   |             |

disruptive_threshold=0.35を採用

### 破壊的変更時に重みをつける

そのルートはなんとなく通りたくないので。

| disruptive_cost |             |
| ---             |             |
| 100             | 91714935134 |
| 10              | 91798926458 |
| 50              | 91700424968 |
| 20              | 91773445200 |

### 破壊的変更時に相対誤差を利用して重みをつける

| disruptive_threshold | disruptive_cost |             |
|----------------------|-----------------|-------------|
| 0.35                 | 20              | 91783979886 |
| 0.35                 | 40              | 91764720352 |
| 0.35                 | 60              | 91689285624 |
| 0.2                  | 60              | 91483837975 |
| 0.1                  | 60              | 90796570860 |
| 0.1                  | 40              | 90766772750 |
| 0.3                  | 40              | 91692637713 |

### prediction < real_distanceなら破壊的変更時に相対誤差を利用して重みをつけない

| disruptive_threshold | disruptive_cost |             |
|----------------------|-----------------|-------------|
| 0.3                  | 40              | 91763498478 |
| 0.35                 | 40              | 91739452216 |
| 0.4                  | 40              | 91693915479 |
| 0.2                  | 40              | 91434753767 |
| 0.35                 | 20              | 91731983263 |
| 0.3                  | 20              | 91730807622 |

破棄

disruptive_threshold=0.35, disruptive_cost=20を採用

### だめなの改善すればいいんじゃね

一番点数の低いサンプルをあぶり出すスクリプトをかいた

### 観察

Rについて各操作ごとの正解の値との差を表示させるスクリプトを書いた。
ついでに、各成分の差の絶対値の和(=X)も表示するようにした。

Xが全然減っていない

### straight_path_cost

| straight_threshold |             |
| --                 |             |
| 0.1                | 91661201818 |
| 0.2                | 91730635021 |
| 0.15               | 91694852971 |
| 0.3                | 91774146625 |
|                    |             |

不採用
else if is_straight(&path) && (relative_error > straight_threshold){
                weighted_update_path_cost(1, 0, &path, new_cost, &mut R, &mut C);
            }

### straight apply
直線の結果を容赦なく採用する。

| straight_apply | straight_threshold | m | n |             |
|----------------|--------------------|---|---|-------------|
| 100            | 0.2                | 1 | 0 | 91478757709 |
| 100            | 0.2                | 4 | 1 | 91517621676 |
| 100            | 0.2                | 3 | 2 | 91469055831 |
| 200            | 0.2                | 4 | 1 | 91309232127 |
| 200            | 0.1                | 4 | 1 | 91319393667 |

straight_apply = 100, straight_threshold = 0.2, m = 4, n = 1

### median

| m1 | n1 | k   | m2 | n2 |             |
|----|----|-----|----|----|-------------|
| 1  | 1  | 100 | 1  | 1  | 89178196364 |
| 2  | 1  | 100 | 2  | 1  | 88871602091 |
| 1  | 2  |     |    |    | 89401782755 |
| 3  | 2  |     |    |    | 89200193528 |
|    |    |     |    |    |             |

### 相対誤差が十分小さい場合は変更しない

| same_threshold |             |
| --             |             |
| 0.1            | 92217068430 |
| 0.2            | 91983057729 |
| 0.15           | 92303522045 |

straight なし

| same_threshold |             |
| --             |             |
| 0.15           | 92337331908 |
| 0.05           | 91879164614 |
| 0.2            | 91985554999 |
| 0.1            | 92211821013 |

pathのstraight化の無効化

| same_threshold |             |
| --             |             |
| 0.15           | 92579215749 |
| 0.05           | 92037958492 |
| 0.1            | 92383543892 |
| 0.2            | 92238506802 |

### straight diff

straightの採用をdiffで制限した。

| straight_apply | straight_threshold             | diff |             |
|----------------|--------------------------------|------|-------------|
| 100            | 0.2                            | 10   | 92605661181 |
| 50             | 0.2                            | 10   | 92594458417 |
| 200            | 0.2                            | 10   | 92544094312 |
| 200*N/(i+N)    | 0.2*N/(N+i)                    | 10   | 92530149291 |
| 100            | 0.15*N/(N+i)                   | 10   | 92610231249 |
| 150            | 0.15*N/(N+i)                   | 10   | 92536979543 |
| 100            | 0.1*N/(N+i)                    | 10   | 92541562780 |
| 100            | 0.1*N/(N+i*N/straight_apply)   | 10   | 92541150489 |
| 150            | 0.15*N/(N+i*N/straight_apply)  | 10   | 92540355103 |
| 100            | 0.15*N/(N+i*N/straight_apply)  | 10   | 92612159582 |
| 50             | 0.15*N/(N+i*N/straight_apply ) | 10   | 92600971081 |
| 80             | 0.15*N/(N+i*N/straight_apply ) | 10   | 92604287335 |
| 150            | 0.15*N/(N+i*N/straight_apply ) | 10   | 92540355103 |
|                |                                |      |             |

- 一旦なし

### mean(3)

| mean |             |
| ---  |             |
| 3500 | 92579215749 |
| 3000 | 92587826301 |
| 4000 | 92401607368 |
| 5000 | 90565426878 |
| 2000 | 92219841166 |
| 1000 | 91804141812 |
| 0    | 91716193474 |
| 3250 | 92481879057 |
| 3750 | 92546950351 |
  
### m:n

dynamical_update_path_cost

| m1 | n1 | k    | m2 | n2 |             |
|----|----|------|----|----|-------------|
| 1  | 1  | N/10 | 1  | 2  | 92587826301 |
| 2  | 1  | N/10 | 1  | 2  | 92493003671 |
| 3  | 2  | N/10 | 1  | 2  | 92511696889 |
| 1  | 1  | N/10 | 2  | 3  | 92476544002 |
| 1  | 1  | N/10 | 1  | 1  | 92360880142 |

m1=1, n1=1, m2=1, n2=2

### smoothing path cost

| k    | K   |             |
| ---- |     |             |
| 1    | 100 | 92638389177 |
| 3    | 100 | 92560667924 |
| 2    | 100 | 92515649719 |
| 1    | 50  | 92552223399 |
| 1    | 200 | 92594741215 |
| 2    | 200 | 92508614895 |

k = i/a+1

| a    | K   |             |
| ---- |     |             |
| 10   | 200 | 92645829048 |
| 10   | 300 | 92645829048 |
| 20   | 200 | 92526075605 |
| 15   | 200 | 92531725779 |
| 15   | 300 | 92532536164 |
| 5    | 200 | 92532536164 |
| 10   | 300 | 92645829048 |
| 100  | 100 | 92638389177 |

効果薄かった

### disruptive count & smoothing

| disruptive_count_threshold | initialize_count | m | n |             |
|----------------------------|------------------|---|---|-------------|
| 10                         | 100              | 1 | 0 | 92602177162 |
| 10                         | 50               | 1 | 0 | 92618221975 |
| 20                         | 100              | 1 | 0 | 92634392198 |
| 30                         | 100              | 1 | 0 | 92638389177 |
| 40                         | 100              | 1 | 0 | 92638389177 |
| 10                         | 100              | 1 | 1 | 92598900907 |

### path based smoothing

disruptive_thresholdを超えた時に行うsmoothingを局所化する

| m | n |             |
|---|---|-------------|
| 1 | 1 | 92768819577 |
| 2 | 1 | 92705027413 |
| 1 | 2 | 92622006967 |
| 3 | 1 | 92678019832 |
| 2 | 3 | 92678724478 |

一旦、m=n=1を採用

### 過去100回の成績に応じて

### mean(4)

| mean |             |
|------|-------------|
| 3000 | 92649954647 |
| 4000 | 92655941236 |
| 5000 | 90639283572 |
| 6000 | 87332384594 |
| 2000 | 92150324014 |
| 1000 | 91729606708 |

mean = 4000


